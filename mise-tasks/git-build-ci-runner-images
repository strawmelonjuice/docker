#!/usr/bin/env bash
#MISE description="Build custom images for CI"
#MISE dir="git"

# Build custom images for CI runners.
echo "Building Ubuntu development image..."
docker build -f custom-images/Dockerfile.ubuntu-dev -t ubuntu-dev:latest . || { echo "Failed to build Ubuntu image"; exit 1; }

echo "Building Fedora development image..."
docker build -f custom-images/Dockerfile.fedora-dev -t fedora-dev:latest . || { echo "Failed to build Fedora image"; exit 1; }

echo "Building Alpine development image..."
docker build -f custom-images/Dockerfile.alpine-dev -t alpine-dev:latest . || { echo "Failed to build Alpine image"; exit 1; }

echo "Build complete!"
echo "Available images:"
echo "  ubuntu-dev:latest"
echo "  fedora-dev:latest (default)"
echo "  alpine-dev:latest"

echo ""
echo "Tagging images for DockerHub..."
docker tag ubuntu-dev:latest strawmelonjuice/git.strawmelonjuice.com-runners:ubuntu-dev
docker tag fedora-dev:latest strawmelonjuice/git.strawmelonjuice.com-runners:fedora-dev
docker tag alpine-dev:latest strawmelonjuice/git.strawmelonjuice.com-runners:alpine-dev

echo ""
echo "Pushing images to DockerHub..."
docker push strawmelonjuice/git.strawmelonjuice.com-runners:ubuntu-dev || { echo "Failed to push Ubuntu image"; exit 1; }
docker push strawmelonjuice/git.strawmelonjuice.com-runners:fedora-dev || { echo "Failed to push Fedora image"; exit 1; }
docker push strawmelonjuice/git.strawmelonjuice.com-runners:alpine-dev || { echo "Failed to push Alpine image"; exit 1; }

echo ""
echo "Push complete! Images available on DockerHub:"
echo "  strawmelonjuice/git.strawmelonjuice.com-runners:ubuntu-dev"
echo "  strawmelonjuice/git.strawmelonjuice.com-runners:fedora-dev"
echo "  strawmelonjuice/git.strawmelonjuice.com-runners:alpine-dev"

echo ""
echo "Cleaning up unused Docker resources..."
docker system prune -a -f