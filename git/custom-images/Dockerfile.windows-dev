# Use Windows Server Core as base image
FROM mcr.microsoft.com/windows/servercore:ltsc2022

# Use PowerShell as the default shell
SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]

# Install Chocolatey package manager
RUN Set-ExecutionPolicy Bypass -Scope Process -Force; \
    [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; \
    iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# Install basic development dependencies via Chocolatey
RUN choco install -y git --params='/GitOnlyOnPath /NoShellIntegration' ; \
    choco install -y curl ; \
    choco install -y 7zip ; \
    choco install -y vim ; \
    choco install -y openssh

# Install Visual Studio Build Tools for native compilation
RUN choco install -y visualstudio2022buildtools --package-parameters="--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended"

# Install mise
RUN choco install -y mise

# Add mise to PATH
RUN setx PATH "%PATH%;C:\ProgramData\chocolatey\bin;C:\Program Files\Git\bin" /M

# Install development tools via mise to match other images
RUN mise install node@lts
RUN mise install bun@latest
RUN mise install rust@latest
RUN mise install gleam@latest
RUN mise install erlang@27
RUN mise install erlang@28

# Preactivate Node and Bun (matching other images)
RUN mise use -g node@lts
RUN mise use -g bun@latest

# Install Gitea tea CLI
RUN $progressPreference = 'silentlyContinue'; \
    Invoke-WebRequest -Uri 'https://gitea.com/gitea/tea/releases/download/v0.11.0/tea-0.11.0-windows-amd64.exe' -OutFile 'C:\Windows\tea.exe'

# Set up mise to work in non-interactive shells
RUN echo 'mise activate powershell | Out-String | Invoke-Expression' >> $PROFILE.AllUsersAllHosts
ENV MISE_ACTIVATE=1

# Add the mise shim path to PATH
RUN setx PATH "%PATH%;C:\Users\ContainerUser\.local\share\mise\shims" /M

# Verify installations
RUN node --version ; npm --version ; git --version ; mise --version ; tea --version

# Set working directory
WORKDIR C:\\workspace

# Set up default shell for container execution
SHELL ["cmd", "/S", "/C"]