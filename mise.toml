[settings]
yes = true

[env]
SITE_IMAGE = "strawmelonjuice-site"
SITE_CONTAINER = "strawmelonjuice-site"

[tasks.all-start]
description = "Start all services"
run = [
  { task = "git-pull-ci-runner-images" },
  { tasks = ["git-start", "git-mirror-sync-start", "strawmediajuice-start", "site-start"] },
]

[tasks.all-stop]
description = "Stop all services"
run = [
  { tasks = ["git-stop", "git-mirror-sync-stop", "strawmediajuice-stop", "site-stop"] },
]

[tasks.all-restart]
description = "Stop and restart all services"
run = [
  { tasks = ["git-restart", "git-mirror-sync-restart", "strawmediajuice-restart","site-restart"] },
]

[tasks.strawmediajuice-start]
description = "Start strawmediajuice service (docker)"
run = "docker compose up -d"
dir = "strawmediajuice"

[tasks.git-pull-ci-runner-images]
description = "Pull CI runner images from dockerhub"
run = [
  "docker pull strawmelonjuice/git.strawmelonjuice.com-runners:alpine-dev",
  "docker pull strawmelonjuice/git.strawmelonjuice.com-runners:ubuntu-dev",
  "docker pull strawmelonjuice/git.strawmelonjuice.com-runners:fedora-dev"
]

[tasks.strawmediajuice-stop]
description = "Stop strawmediajuice service (docker)"
run = "docker compose down"
dir = "strawmediajuice"

[tasks.strawmediajuice-restart]
description = "Stop and restart strawmediajuice service (docker)"
run = [
{ task = "strawmediajuice-stop" },
  { task = "strawmediajuice-start" },
]

[tasks.git-mirror-sync-start]
description = "Start git mirror service (systemd/bash)"
run = "systemctl start git-mirror-sync.service"

[tasks.git-mirror-sync-stop]
description = "Stop git mirror service (systemd/bash)"
run = "systemctl stop git-mirror-sync.service"

[tasks.git-mirror-sync-restart]
description = "Stop and restart git mirror service (systemd/bash)"
run = [
{ task = "git-mirror-sync-stop" },
  { task = "git-mirror-sync-start" },
]

[tasks.git-stop]
description = "Stop forgejo and runners (docker)"
run = "docker compose down"
dir = "git"

[tasks.git-restart]
description = "Stop and restart forgejo service (docker)"
run = [
{ task = "git-stop" },
  { task = "git-start" },
]

[tasks.site-start]
description="Start strawmelonjuice site (Podman/Cynthia)"
run= [
"docker build . -t {{env.SITE_IMAGE}} --network=host",
"docker run -d --restart unless-stopped -p 3033:8080 --name {{env.SITE_CONTAINER}} {{env.SITE_IMAGE}}:latest"
]
dir = "strawmelonjuice-site"

[tasks.site-stop]
description="Stop strawmelonjuice site (Podman/Cynthia)"
run = [
    "docker stop {{env.SITE_CONTAINER}} || true",
    "docker rm {{env.SITE_CONTAINER}} || true",
    "docker rmi {{env.SITE_IMAGE}}:latest || true"
]
dir = "strawmelonjuice-site"

[tasks.site-restart]
description = "Stop and restart strawmelonjuice site (Podman/Cynthia)"
run = [
{ task = "site-stop" },
  { task = "site-start" },
]

[tasks.site-generate]
description = "Generate strawmelonjuice site only if changes exist"
run = [
  """
  # Check and install cynthiaweb-mini if not present
  if [ ! -f "./cynthiaweb-mini" ]; then
  echo "cynthiaweb-mini not found, installing..."
  curl -L -o cynthiaweb-mini-weekly.tgz https://github.com/strawmelonjuice/Mini-strawmelonjuice.com/releases/download/weekly-build/cynthiaweb-mini-weekly.tgz
  mkdir -p build
  tar -xzf cynthiaweb-mini-weekly.tgz -C build
  bun build --compile build/dist/cynthia_websites_mini_server.js --outfile ./cynthiaweb-mini
  chmod +x ./cynthiaweb-mini
  rm cynthiaweb-mini-weekly.tgz
  rm -rf build
  echo "cynthiaweb-mini installed successfully."
else
  echo "âœ“ cynthiaweb-mini is already installed."
fi
  """,
  """
  # 1. Initialize directory if it doesn't exist
  if [ ! -d "./source" ]; then
    git clone https://codeberg.org/strawmelonjuice/site ./source
    git -C ./source remote set-url origin https://forge.strawmelonjuice.com/strawmelonjuice/site.git
  fi

  # 2. Check for remote changes
  cd ./source
  git fetch origin main -q
  
  LOCAL=$(git rev-parse HEAD)
  REMOTE=$(git rev-parse @{u})

  if [ "$LOCAL" != "$REMOTE" ]; then
    echo "Changes detected! Regenerating site..."
    git reset --hard @{u}
    ../cynthiaweb-mini static
    rsync -a --delete ./out/ ../out/
    echo "Site updated successfully."
  else
    echo "No changes found. Skipping generation."
  fi
  """
]
dir = "strawmelonjuice-site"