[settings]
yes = true

[env]
SITE_IMAGE = "strawmelonjuice-site"
SITE_CONTAINER = "strawmelonjuice-site"

[tasks.all-start]
description = "Start all services"
run = [
  { tasks = ["caddy-start","forge-start", "git-mirror-sync-start", "strawmediajuice-start", "site-start"] },
]

[tasks.all-stop]
description = "Stop all services"
run = [
  { tasks = ["caddy-stop","forge-stop", "git-mirror-sync-stop", "strawmediajuice-stop", "site-stop"] },
]

[tasks.all-restart]
description = "Stop and restart all services"
run = [
  { tasks = ["caddy-restart","forge-restart", "git-mirror-sync-restart", "strawmediajuice-restart","site-restart"] },
]

[tasks.caddy-start]
description = "Start Caddy (Docker)"
run = "docker compose up -d"
dir = "caddy"

[tasks.caddy-stop]
description = "Stop Caddy (Docker)"
run = "docker compose down"
dir = "caddy"

[tasks.caddy-restart]
description = "Stop and restart Caddy (docker)"
run = [
{ task = "caddy-stop" },
  { task = "caddy-start" },
]

[tasks.strawmediajuice-start]
wait_for="forge-start"
description = "Start strawmediajuice service (docker)"
run = "docker compose up -d"
dir = "strawmediajuice"

[tasks.strawmediajuice-stop]
description = "Stop strawmediajuice service (docker)"
run = "docker compose down"
dir = "strawmediajuice"

[tasks.strawmediajuice-restart]
description = "Stop and restart strawmediajuice service (docker)"
run = [
{ task = "strawmediajuice-stop" },
  { task = "strawmediajuice-start" },
]

[tasks.git-mirror-sync-start]
description = "Start git mirror service (systemd/bash)"
run = "systemctl start git-mirror-sync.service"

[tasks.git-mirror-sync-stop]
description = "Stop git mirror service (systemd/bash)"
run = "systemctl stop git-mirror-sync.service"

[tasks.git-mirror-sync-restart]
description = "Stop and restart git mirror service (systemd/bash)"
run = [
{ task = "git-mirror-sync-stop" },
  { task = "git-mirror-sync-start" },
]

[tasks.forge-start]
description="Start forgejo (docker)"
dir = "forgejo"
run = "docker compose up -d"

[tasks.forge-stop]
description = "Stop forgejo (docker)"
run = "docker compose down"
dir = "forgejo"

[tasks.forge-restart]
description = "Stop and restart forgejo service (docker)"
run = [
{ task = "forge-stop" },
  { task = "forge-start" },
]

[tasks.knot-start]
alias="tangled-start"
description="Start tangled.org knot (docker)"
dir = "tangled"
run = "docker compose up -d"

[tasks.knot-stop]
alias="tangled-stop"
description = "Stop tangled.org knot (docker)"
run = "docker compose down"
dir = "tangled"

[tasks.knot-restart]
alias="tangled-restart"
description = "Stop and restart tangled.org knot (docker)"
run = [
{ task = "knot-stop" },
  { task = "knot-start" },
]

[tasks.site-start]
description="Start strawmelonjuice site (systemd/Cynthia/nginx)"
run= [
  "systemctl start site-gen.service"
]
dir = "strawmelonjuice-site"

[tasks.site-stop]
description="Stop strawmelonjuice site (systemd/Cynthia/nginx)"
run = [
    "systemctl stop site-gen.service"
]
dir = "strawmelonjuice-site"

[tasks.site-restart]
description = "Stop and restart strawmelonjuice site (systemd/Cynthia/nginx)"
run = [
{ task = "site-stop" },
  { task = "site-start" },
]

[tasks.site-generate]
tools   = { bun = "latest" }
description = "Generate strawmelonjuice site only if changes exist"
run = [
  """
  # Check and install cynthiaweb-mini if not present
  if [ ! -f "./cynthiaweb-mini" ]; then
  echo "cynthiaweb-mini not found, installing..."
  curl -L -o cynthiaweb-mini-weekly.tgz https://github.com/strawmelonjuice/Mini-strawmelonjuice.com/releases/download/weekly-build/cynthiaweb-mini-weekly.tgz
  mkdir -p build
  tar -xzf cynthiaweb-mini-weekly.tgz -C build
  bun build --compile build/dist/cynthia_websites_mini_server.js --outfile ./cynthiaweb-mini
  chmod +x ./cynthiaweb-mini
  rm cynthiaweb-mini-weekly.tgz
  rm -rf build
  echo "cynthiaweb-mini installed successfully."
else
  echo "âœ“ cynthiaweb-mini is already installed."
fi
  """,
  """
  # 1. Initialize directory if it doesn't exist
  if [ ! -d "./source" ]; then
    git clone https://codeberg.org/strawmelonjuice/site ./source
    sleep 15s
    git -C ./source remote set-url origin git@forge.strawmelonjuice.com:strawmelonjuice/site.git
  fi

  # 2. Check for remote changes
  cd ./source
  git fetch origin main -q

  LOCAL=$(git rev-parse HEAD)
  REMOTE=$(git rev-parse @{u})

  if [ "$LOCAL" != "$REMOTE" ] || [ ! -d "./out" ]; then
    echo "Changes detected! Regenerating site..."
    git reset --hard @{u}
    ../cynthiaweb-mini static
    rsync -a --delete ./out/ ../out/
    echo "Site updated successfully."
  else
    echo "No changes found. Skipping generation."
  fi
  """
]
dir = "strawmelonjuice-site"
